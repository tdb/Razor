#!/bin/bash

set -u
#set -e

function install_puppet() {
    apt-get -y purge facter
    apt-get -y --purge autoremove
    echo "deb https://apt.puppetlabs.com `lsb_release -cs` main dependencies" > /etc/apt/sources.list.d/puppetlabs.list
    curl https://apt.puppetlabs.com/pubkey.gpg | apt-key add -
    apt-get update
    apt-get -y install puppet
}

function configure_puppet() {
    if [ -f /etc/default/puppet ]; then
        sed -i 's/START\s*=\s*no/START=yes/gi' /etc/default/puppet
    fi
}

function run_agent() {
    puppet agent --enable
    puppet agent -t
    /etc/init.d/puppet start
}

#This fuction is not called if no custom facts are given
#
# The Puppet Labs stdlib module is required for this to work
#It can be installed using:
# puppet-module install puppetlabs/stdlib
function facts_dot_d() {
    mkdir -p /etc/facter/facts.d
    <% if @options[:metadata] %>
        echo Installing custom facts
        <% @options[:metadata].each do |fact,value| %>
            <% if value && !value.empty? %>
                echo '<%= fact %>=<%= value %>' > /etc/facter/facts.d/<%= fact %>.txt
            <% end %>
        <% end %>
    <% end %>
}

function provision_puppet() {
    install_puppet
    configure_puppet
    <%= 'facts_dot_d' if @options[:metadata] %>
    run_agent
    echo Puppet installation finished!
    exit 0
}

provision_puppet
