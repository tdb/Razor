#!/bin/bash

set -u
#set -e

function install_puppet() {
    apt-get -y purge facter
    apt-get -y --purge autoremove
    echo "deb https://apt.puppetlabs.com `lsb_release -cs` PC1" > /etc/apt/sources.list.d/puppetlabs-pc1.list
    curl https://apt.puppetlabs.com/pubkey.gpg | apt-key add -
    apt-get update
    apt-get -y install puppet-agent
}

function run_agent() {
    /opt/puppetlabs/bin/puppet agent --enable
    /opt/puppetlabs/bin/puppet agent -t
    /opt/puppetlabs/bin/puppet resource service puppet ensure=running enable=true
}

#This fuction is not called if no custom facts are given
#
# The Puppet Labs stdlib module is required for this to work
#It can be installed using:
# puppet-module install puppetlabs/stdlib
function facts_dot_d() {
    mkdir -p /etc/facter/facts.d
    <% if @options[:metadata] %>
        echo Installing custom facts
        <% @options[:metadata].each do |fact,value| %>
            <% if value && !value.empty? %>
                echo '<%= fact %>=<%= value %>' > /etc/facter/facts.d/<%= fact %>.txt
            <% end %>
        <% end %>
    <% end %>
}

function provision_puppet() {
    install_puppet
    <%= 'facts_dot_d' if @options[:metadata] %>
    run_agent
    echo Puppet installation finished!
    exit 0
}

provision_puppet
